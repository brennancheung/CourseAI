<!DOCTYPE html>
<html>
<head>
  <title>SpessaSynth Vanilla JS Test</title>
  <style>
    body { font-family: system-ui; max-width: 800px; margin: 40px auto; padding: 20px; }
    button { padding: 12px 24px; font-size: 16px; margin: 8px; cursor: pointer; }
    #log { background: #111; color: #0f0; padding: 16px; font-family: monospace; font-size: 12px;
           height: 400px; overflow-y: auto; white-space: pre-wrap; }
    #status { padding: 16px; background: #eee; margin: 16px 0; font-weight: bold; }
  </style>
  <!-- Import map to resolve spessasynth modules -->
  <script type="importmap">
    {
      "imports": {
        "spessasynth_core": "/spessasynth_core.js",
        "spessasynth_lib": "/spessasynth_lib.js"
      }
    }
  </script>
</head>
<body>
  <h1>SpessaSynth Vanilla JS Test</h1>
  <p>No React, no Next.js - just vanilla JavaScript following the official example.</p>

  <button onclick="testBasicAudio()">Test Basic Web Audio</button>
  <button onclick="initAndPlay()">Init SpessaSynth & Play</button>
  <button onclick="playNote()" id="playBtn" disabled>Play Another Note</button>

  <div id="status">Click a button to start</div>
  <div id="log"></div>

  <script type="module">
    // Make functions available globally
    window.testBasicAudio = testBasicAudio;
    window.initAndPlay = initAndPlay;
    window.playNote = playNote;

    let synth = null;
    let ctx = null;

    function log(msg) {
      const time = new Date().toISOString().split('T')[1].slice(0, 12);
      const entry = `[${time}] ${msg}`;
      console.log(entry);
      document.getElementById('log').textContent += entry + '\n';
      document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
    }

    function status(msg) {
      document.getElementById('status').textContent = msg;
    }

    function testBasicAudio() {
      log('Testing basic Web Audio...');
      const audioCtx = new AudioContext();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      gain.gain.value = 0.3;
      osc.frequency.value = 440;
      osc.start();
      log('Oscillator playing at 440Hz');
      setTimeout(() => {
        osc.stop();
        audioCtx.close();
        log('Oscillator stopped');
      }, 500);
    }

    async function initAndPlay() {
      try {
        document.getElementById('log').textContent = '';
        status('Initializing...');

        // Step 1: Create AudioContext
        log('Creating AudioContext...');
        ctx = new AudioContext();
        log(`AudioContext state: ${ctx.state}, sampleRate: ${ctx.sampleRate}`);

        // Step 2: Load the worklet processor
        log('Loading AudioWorklet processor...');
        await ctx.audioWorklet.addModule('/spessasynth_processor.min.js');
        log('Worklet loaded');

        // Step 3: Import and create synthesizer
        log('Importing spessasynth_lib...');
        const { WorkletSynthesizer } = await import('spessasynth_lib');
        log('Creating WorkletSynthesizer...');
        synth = new WorkletSynthesizer(ctx);
        log('Synth created');

        // Step 4: Load soundfont (using tiny 50KB test font)
        status('Loading soundfont (50KB)...');
        log('Fetching tiny soundfont...');
        const response = await fetch('/soundfonts/tiny.sf2');
        const sfData = await response.arrayBuffer();
        log(`Soundfont fetched: ${sfData.byteLength} bytes`);

        log('Adding soundfont to synth...');
        await synth.soundBankManager.addSoundBank(sfData, 'sonatina');
        log('Soundfont added');

        // Step 5: Wait for ready
        log('Waiting for synth.isReady...');
        await synth.isReady;
        log('Synth is ready!');
        log(`Presets: ${synth.presetList.length}`);

        // Step 6: Connect to output
        log('Connecting to destination...');
        synth.connect(ctx.destination);
        log('Connected');

        // Step 7: Resume context and play
        log('Resuming AudioContext...');
        await ctx.resume();
        log(`Context state: ${ctx.state}`);

        status('Playing test note...');
        log('programChange(0, 0) - first preset in soundfont');
        synth.programChange(0, 0);

        log('noteOn(0, 60, 127)');
        synth.noteOn(0, 60, 127);
        log('>>> You should hear a piano note NOW <<<');

        setTimeout(() => {
          synth.noteOff(0, 60);
          log('noteOff sent');
          status('Done! Did you hear a note? Click "Play Another Note" to try again.');
          document.getElementById('playBtn').disabled = false;
        }, 1000);

      } catch (err) {
        log(`ERROR: ${err.message}`);
        console.error(err);
        status(`Error: ${err.message}`);
      }
    }

    function playNote() {
      if (!synth || !ctx) {
        log('Synth not initialized');
        return;
      }
      ctx.resume();
      const note = 48 + Math.floor(Math.random() * 24); // Random note C3-B4
      log(`Playing random note: ${note}`);
      synth.noteOn(0, note, 100);
      setTimeout(() => synth.noteOff(0, note), 500);
    }
  </script>
</body>
</html>
